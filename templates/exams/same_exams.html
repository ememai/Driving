{% extends "base.html" %} {% load static custom_filters %} 
{% block title %}Exams{% endblock %} {% block content %}

<style>
  .exam-header {
    margin-top: 4rem;
    margin-bottom: 2rem;
    text-align: center;
  }

  .exam-header h2 {
    font-size: 2rem;
    font-weight: 700;
    color: rgba(var(--text-rgb), 1);
  }

  .exam-header p.lead {
    font-size: 1.1rem;
    color: rgba(var(--text-rgb), 0.65);
  }

  .exam-card {
    background-color: rgba(var(--card-bg-rgb), 0.8);
    border: 1px solid rgba(var(--border-rgb), 0.2);
    border-radius: 1rem;
    transition: all 0.3s ease;
    padding: 1.5rem;
    box-shadow: 0 8px 24px rgba(0, 0, 0, 0.05);
    display: flex;
    flex-direction: column;
    gap: 0.75rem;
    position: relative;
    color: rgba(var(--text-rgb), 1);
    will-change: transform, box-shadow;
    contain: layout style paint;
    content-visibility: auto;
  }

  .exam-card:hover {
    transform: translateY(-4px);
    box-shadow: 0 12px 30px rgba(0, 0, 0, 0.1);
  }

  .exam-icon {
    font-size: 2.5rem;
    text-align: center;
  }

  .exam-icon i {
    transition: transform 0.4s ease;
    display: inline-block;
    will-change: transform;
  }

  .exam-card:hover .exam-icon i {
    transform: scale(1.25) rotate(2deg);
    animation: pulseIcon 1s ease-in-out infinite;
  }

  @keyframes pulseIcon {
    0%,
    100% {
      transform: scale(1.15);
    }
    50% {
      transform: scale(1.25) rotate(2deg);
    }
  }

  .exam-card h2 {
    font-size: 1.5rem;
    font-weight: 600;
    text-align: center;
  }

  .exam-badge {
    position: absolute;
    top: 1rem;
    right: 1rem;
    padding: 0.35rem 0.6rem;
    border-radius: 0.5rem;
    font-size: 0.75rem;
    font-weight: 600;
    color: #fff;
  }

  .badge-easy {
    background-color: rgba(var(--success-rgb), 1);
  }
  .badge-medium {
    background-color: rgba(var(--warning-rgb), 1);
    color: #000;
  }
  .badge-hard {
    background-color: rgba(var(--danger-rgb), 1);
  }

  .no-exams {
    text-align: center;
    margin-top: 0;
    font-size: 1.2rem;
  }

  .exam-card.completed {
    background-color: rgba(40, 167, 69, 0.05);
  }

  .exam-col.hidden {
    display: none;
  }

  .load-more-btn {
    display: block;
    margin: 2rem auto;
  }

  .load-more-btn:disabled {
    opacity: 0.5;
    cursor: not-allowed;
  }
</style>

<div class="container">
  <div class="exam-header">
    <h2>Ibizamini bifite ibibazo byo mu bwoko "{{ exam_type }}"</h2>
  </div>

  {% comment %} server-side no-results alert now rendered inside each year pane
  instead {% endcomment %} {% if returned_exams %} {% comment %} {# only show
  tabs and filters when more than one year exists #} {% endcomment %} 
  {% if show_tabs %}
  <ul class="nav nav-tabs" id="yearTabs" role="tablist">
    {% for year in exams_by_year.keys %}
    <li class="nav-item" role="presentation">
      <button
        class="nav-link {% if forloop.first %}active{% endif %}"
        id="tab-{{ year }}"
        data-bs-toggle="tab"
        data-bs-target="#year-{{ year }}"
        type="button"
        role="tab"
        aria-controls="year-{{ year }}"
        aria-selected="{{ forloop.first|yesno:'true,false' }}"
      >
        {{ year }}
      </button>
    </li>
    {% endfor %}
  </ul>
  {% endif %}

  <div class="tab-content mt-4" id="yearTabsContent">
    {% for year, exams in exams_by_year.items %}
    <div
      class="tab-pane fade {% if forloop.first %}show active{% endif %}"
      id="year-{{ year }}"
      role="tabpanel"
      aria-labelledby="tab-{{ year }}"
    >
      {% if exams %} {% if show_tabs %}
      <div class="mb-3 d-flex gap-2 align-items-center flex-wrap">
        <label class="mb-0">HITAMO Ukwezi:</label>
        <select
          class="form-select form-select-sm w-auto month-filter"
          data-year="{{ year }}"
        >
          <option value="all">Amezi yose</option>
          {% for m, mname in exams_months_by_year|dictkey:year %}
          <option value="{{ m }}">Ukwa {{ m }}</option>
          {% endfor %}
        </select>

        <div class="form-check ms-3 form-check-reverse">
          <input
            class="form-check-input completed-filter"
            type="checkbox"
            value="1"
            id="completedOnly-{{ year }}"
            data-year="{{ year }}"
          />
          <label class="form-check-label" for="completedOnly-{{ year }}">
            Ibyo wakoze gusa?
          </label>
        </div>

        <button
          type="button"
          class="btn btn-sm btn-outline-secondary reset-filters ms-auto"
          data-year="{{ year }}"
          title="Clear all filters for this year"
        >
          <i class="fas fa-eraser"></i>
          Reset
        </button>
      </div>
      {% endif %}
        <p class="mb-2">Umubare w'ibibonetse: <strong class="exam-count-display" data-year="{{ year }}">{{ exams|length }}</strong></p>

      <!-- alert shown when no cards are visible (server or client filtering) -->
      <div
        class="alert alert-info d-flex justify-content-between align-items-center mt-3 no-results-info {% if filtered_count != 0 %}d-none{% endif %}"
      >
        <div>
          Nta bizamini bihuye n'ibyatoranyijwe. Gerageza gukuraho filtre
          kugirango ubone byinshi.
        </div>
      </div>

      <div class="row g-4" data-exam-container="true">
        {% for exam in exams %}
        <div class="col-md-6 col-lg-4 exam-col">
          <div
            class="exam-card {% if exam.id in completed_exam_ids %}border-success{% endif %}"
            data-month="{{ exam.created_at|date:'n' }}"
            data-completed="{% if exam.id in completed_exam_ids %}1{% else %}0{% endif %}"
          >
            {% if exam.id in completed_exam_map %}
            <div class="progress mt-0">
              <div class="progress-bar bg-success" style="width: 100%">
                Waragikoze kuri: 
                {{ completed_exam_map|dictkey:exam.id|date:"d - m - Y H:i" }}
              </div>
            </div>
            {% endif %}

            <div class="exam-icon">
              <i
                class="{{ exam.exam_type.icon|default:'fas fa-question-circle' }}"
              ></i>
            </div>

            <h2>{{ forloop.counter }}</h2>
            <p>
              <strong>Cyateguwe:</strong> {{ exam.created_at|date:"d.m.Y" }}
            </p>
            <p><strong>Ibibazo:</strong> {{ exam.total_questions }}</p>

            {% if exam.difficulty == 'easy' %}
            <span class="exam-badge badge-easy">Byoroshye</span>
            {% elif exam.difficulty == 'medium' %}
            <span class="exam-badge badge-medium">Hagati</span>
            {% elif exam.difficulty == 'hard' %}
            <span class="exam-badge badge-hard">Bikomeye</span>
            {% endif %}

            <a
              href="{% url 'exam_detail' exam.id %}"
              class="btn btn-outline-primary"
            >
              {% if exam.id in completed_exam_map %} Gisubiremo {% else %}
              Gikore {% endif %}
            </a>
          </div>
        </div>
        {% endfor %}
      </div>
      <!-- pagination: load more button -->
      <div class="text-center mt-4" data-pagination-controls="true">
        <button
          type="button"
          class="btn btn-sm btn-outline-primary load-more-btn"
          data-year="{{ year }}"
          style="display: none"
        >
          <span
            class="spinner-border spinner-border-sm me-2"
            role="status"
            aria-hidden="true"
            style="display: none"
          ></span>
          Ibindi
        </button>
      </div>
      {% else %}
      <p class="no-exams text-muted">Nta bizamini bibonetse muri uyu mwaka.</p>
      {% endif %}
    </div>
    {% endfor %}
  </div>
  {% else %}
  <p class="no-exams text-muted">
    Nta bizamini bibonetse muri ubu bwoko.
    <a href="{% url 'exams' mixed_exam_types %}" class="fs-6">
      Reba ibivanze
    </a>
  </p>
  {% endif %}
</div>

<script>
  (function(){
    const EXAM_TYPE_KEY = 'exams_filters__{{ exam_type|slugify }}';
    const PAGINATION_THRESHOLD = 50; // activate when 50+ exams
    const ITEMS_PER_LOAD = 15; // load 15 per click
    let storageCache = {};
    let paginationState = {};

    function readStorage(){
      if(!Object.keys(storageCache).length){
        try { storageCache = JSON.parse(localStorage.getItem(EXAM_TYPE_KEY)) || {}; }
        catch { storageCache = {}; }
      }
      return storageCache;
    }
    function writeStorage(obj){
      storageCache = obj;
      localStorage.setItem(EXAM_TYPE_KEY, JSON.stringify(obj));
    }

    function applyFilters(container, year){
      const sel = container.querySelector('.month-filter');
      const chk = container.querySelector('.completed-filter');
      const month = sel ? sel.value : 'all';
      const completedOnly = chk ? chk.checked : false;

      // persist selection
      const store = readStorage();
      store[year] = { month: month, completed: completedOnly ? '1' : '0' };
      writeStorage(store);

      // update URL to reflect active filters
      const url = new URL(window.location);
      url.searchParams.set('filter_year', year);
      url.searchParams.set('filter_month', month);
      url.searchParams.set('filter_completed', completedOnly ? '1' : '0');
      window.history.replaceState({}, '', url);

      // single loop: determine matches, apply pagination and count visible
      const cards = container.querySelectorAll('.exam-card');
      const allCols = container.querySelectorAll('.exam-col');
      const totalExams = allCols.length;
      const usePagination = totalExams > PAGINATION_THRESHOLD;
      const displayed = usePagination ? (paginationState[year] && paginationState[year].displayed ? paginationState[year].displayed : ITEMS_PER_LOAD) : Infinity;
      let visible = 0;
      let matchCount = 0;
      cards.forEach(card => {
        const cardMonth = card.getAttribute('data-month');
        const cardCompleted = card.getAttribute('data-completed') === '1';
        let matches = true;
        if(month !== 'all' && cardMonth !== month) matches = false;
        if(completedOnly && !cardCompleted) matches = false;
        const col = card.parentElement;
        // mark whether this col matches filters
        col.dataset.match = matches ? '1' : '0';
        if(matches){
          matchCount++;
          // if using pagination, only show first `displayed` matched items
          if(usePagination && matchCount > displayed){
            col.classList.add('hidden');
            col.dataset.paginated = '1';
          } else {
            col.classList.remove('hidden');
            col.dataset.paginated = '0';
            visible++;
          }
        } else {
          col.classList.add('hidden');
          col.dataset.paginated = '0';
        }
      });

      // update per-year count display inside this pane (show total filtered count, not just displayed)
      const countEl = container.querySelector('.exam-count-display');
      if(countEl){
        countEl.textContent = matchCount;
      }

      // toggle the no-results alert inside this pane
      const noResultsAlert = container.querySelector('.no-results-info');
      if(noResultsAlert){
        noResultsAlert.classList.toggle('d-none', visible !== 0);
      }

      // update pagination controls (show Load More if 50+ exams and more matches exist)
      const paginationControls = container.closest('[role="tabpanel"]').querySelector('[data-pagination-controls]');
      if(paginationControls){
        const btn = paginationControls.querySelector('.load-more-btn');
        if(btn && totalExams > PAGINATION_THRESHOLD && matchCount > displayed){
          btn.style.display = 'block';
        } else if(btn){
          btn.style.display = 'none';
        }
      }
    }

    function initPagination(year){
      const tab = document.querySelector('#year-' + year);
      if(!tab) return;
      const container = tab.querySelector('[data-exam-container]');
      if(!container) return;
      if(!paginationState[year]) paginationState[year] = { displayed: ITEMS_PER_LOAD };
      const cols = Array.from(container.querySelectorAll('.exam-col'));
      let toReveal = ITEMS_PER_LOAD;
      for(const col of cols){
        if(toReveal <= 0) break;
        if(col.dataset.match !== '1') continue; // only consider matched items
        if(col.dataset.paginated === '1'){
          col.classList.remove('hidden');
          col.dataset.paginated = '0';
          paginationState[year].displayed++;
          toReveal--;
        }
      }

      // hide button when no more paginated items remain
      const remainingPaginated = cols.filter(c => c.dataset.match === '1' && c.dataset.paginated === '1').length;
      const btn = tab.querySelector('[data-pagination-controls] .load-more-btn');
      if(btn && remainingPaginated === 0){
        btn.style.display = 'none';
      }
    }
    function loadMore(year){
      const tab = document.querySelector('#year-' + year);
      if(!tab) return;
      const container = tab.querySelector('[data-exam-container]');
      if(!container) return;
      
      const cols = container.querySelectorAll('.exam-col');
      if(!paginationState[year]) paginationState[year] = { displayed: ITEMS_PER_LOAD };
      
      let loaded = 0;
      cols.forEach((col, idx) => {
        if(col.classList.contains('hidden') && loaded < ITEMS_PER_LOAD){
          col.classList.remove('hidden');
          paginationState[year].displayed++;
          loaded++;
        }
      });
      
      // hide button when all visible
      const visibleCount = Array.from(cols).filter(c => !c.classList.contains('hidden')).length;
      const btn = tab.querySelector('[data-pagination-controls] .load-more-btn');
      if(btn && visibleCount >= cols.length){
        btn.style.display = 'none';
      }
    }

    function resetFilters(year){
      const tab = document.querySelector('#year-' + year);
      if(!tab) return;
      const sel = tab.querySelector('.month-filter');
      const chk = tab.querySelector('.completed-filter');
      if(sel) sel.value = 'all';
      if(chk) chk.checked = false;
      applyFilters(tab, year);
    }

    function resetAllFilters(){
      // clear any stored per-exam-type filter keys
      for(let i = localStorage.length - 1; i >= 0; i--){
        const key = localStorage.key(i);
        if(key && key.startsWith('exams_filters__')) localStorage.removeItem(key);
      }
      storageCache = {};
      // remove filter query params and reload root path
      const url = new URL(window.location);
      url.searchParams.delete('filter_year');
      url.searchParams.delete('filter_month');
      url.searchParams.delete('filter_completed');
      window.location.href = url.pathname;
    }

    // single setup pass for all tabs
    document.querySelectorAll('.tab-pane').forEach(tab => {
      const year = tab.id.replace('year-', '');
      paginationState[year] = { displayed: ITEMS_PER_LOAD };
      const store = readStorage();
      const saved = store[year] || {};
      const sel = tab.querySelector('.month-filter');
      const chk = tab.querySelector('.completed-filter');
      if(sel){
        {% if filter_month %}
        sel.value = '{{ filter_month }}';
        {% else %}
        sel.value = saved.month || sel.value || 'all';
        {% endif %}
      }
      if(chk){
        {% if filter_completed %}
        chk.checked = '{{ filter_completed }}' === '1';
        {% else %}
        chk.checked = (saved.completed === '1');
        {% endif %}
      }

      tab.addEventListener('change', function(e){
        if(e.target.matches('.month-filter') || e.target.matches('.completed-filter')){
          applyFilters(tab, year);
        }
      });

      // attach reset button handler for this year
      const resetBtn = tab.querySelector('.reset-filters');
      if(resetBtn){
        resetBtn.addEventListener('click', function(){
          resetFilters(year);
        });
      }

      // attach load more button handler
      const loadMoreBtn = tab.querySelector('[data-pagination-controls] .load-more-btn');
      if(loadMoreBtn){
        loadMoreBtn.addEventListener('click', function(){
          loadMore(year);
        });
      }

      applyFilters(tab, year);
      initPagination(year);
    });

    // tab switch handler
    const yearTabs = document.querySelector('#yearTabs');
    if(yearTabs){
      yearTabs.addEventListener('shown.bs.tab', function(e){
        const target = document.querySelector(e.target.getAttribute('data-bs-target'));
        if(target) applyFilters(target, target.id.replace('year-',''));
      });
    }

    {% if active_year %}
    (function openActive(){
      const btn = document.querySelector('#tab-{{ active_year }}');
      if(btn) btn.click();
    })();
    {% endif %}
  })();
</script>

{% endblock %}
