{% extends 'base.html' %}
{% load static custom_filters %}

{% block title %}Exam | {{ exam.title }}{% endblock %}

{% block navbar %}
<nav class="fixed-top">
  <div class="navbar navbar-expand-lg py-1 text-light border-bottom border-theme shadow-sm" id="navbar" role="navigation" style="background-color: rgba(0, 0, 50, 0.8);">

  <div class="container-fluid d-flex justify-content-between align-items-center">
    <a class="navbar-brand bold-logo text-light" href="/">
      <img src="{% static 'img/logo.png' %}" alt="Amategeko y'umuhanda" width="30" height="30" class="d-inline-block align-top"> IGAZETI.RW
    </a>
    <div class="justify-content-center">
      <div class="d-flex align-items-center">
        <span class="me-2"><strong>Igihe gisigaye:</strong></span>
        <span id="countdown" class="badge bg-success fs-4" role="timer" aria-live="polite"></span>
      </div>
    </div>
  </div>
  </div>
  
    
      <div class="progress d-flex align-items-center justify-content-center" style="height: 20px;">
        <div >
          <strong class="fs-6"> Ikibazo cya {{ question_number }} muri {{ total_questions }}</strong>
        </div>
      </div>
</nav>
{% endblock %}

{% block content %}
<style>
  /* Hide radio buttons */
  input[type="radio"] {
    display: none;
  }
  /* Style for the selected choice */
  .selected-choice {
    background-color: blue;
    color: white;
    padding: 5px;
    border-radius: 5px;
  }
  /* Make labels clickable */
  .form-check-label {
    cursor: pointer;
    display: inline-block;
    width: 100%;
  }
  .choices-letters {
    font-weight: bold;
    margin-right: 5px;
  }

  .q-sign {
    border:none ;
    box-shadow: none;
    max-width: 100vw !important;
    height: auto;
  }

  @media(min-width: 495px){

    main {
      padding-top: 50px;
    }

    .q-sign {
      max-width: 70vw !important;
      height: auto;
    }
  }

  #question-nav {
    display: grid;
    grid-template-columns: repeat(10, 40px);
    gap: 4px;
    justify-content: center;
    margin: 0 auto;
    padding: 0;
  }

  @media (max-width: 768px) {
    #question-nav {
      grid-template-columns: repeat(8, 40px);
      
    }
    main {
      padding-top: 80px;
    }
  }
  
  #question-nav button {
    width: 40px;
    height: 40px;
    text-align: center;
    line-height: 40px;
    padding: 0;
    margin: 0;
    border-radius: 4px;
    font-weight: bold;
    transition:
      background-color 0.3s ease,
      color 0.3s ease,
      border-color 0.3s ease,
      transform 0.2s ease;
  }
  
  #question-nav button:hover {
    transform: scale(1.05);
  }
  
  /* Active question */
  #question-nav .btn-primary {
    background-color: #007bff;
    border-color: #007bff;
    color: #fff;
  }
  
  /* Answered questions */
  #question-nav .btn-success {
    background-color: #e0ffe0;  /* light green background */
    border: 2px solid #28a745;  /* green border */
    color: #28a745;
    position: relative;
  }
  
  /* Optional: Add a dot in the corner */
  #question-nav .btn-success::after {
    content: '';
    position: absolute;
    top: 4px;
    right: 4px;
    width: 6px;
    height: 6px;
    background-color: #28a745;
    border-radius: 50%;
  }
  
  /* Unanswered buttons */
  #question-nav .btn-outline-secondary {
    background-color: #fff;
    border: 1px solid #ced4da;
    color: #6c757d;
  }
  
  
  

  .row {
   min-height: 40px; /* Set a minimum height for rows */
  }

  
</style>

<style>
  /* Add smooth fade-in for question and answers */
  .question-container, .choices-container {
    animation: fadeIn 0.5s ease-in-out;
  }

  @keyframes fadeIn {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
  }

  /* Enhanced selected choice indicator */
  .form-check-input:checked + .form-check-label {
    background-color: #0d6efd;
    color: #fff;
    font-weight: bold;
    border-radius: 0.5rem;
    padding: 0.5rem;
    box-shadow: 0 2px 6px rgba(13, 110, 253, 0.5);
  }

  
</style>

<!-- Button tweaks -->
<style>
  .btn {
    border-radius: 6px;
    font-weight: 600;
  }
  .btn-primary:hover {
    background-color: #0b5ed7;
  }
  .btn-success:hover {
    background-color: #198754;
  }
</style>

<!-- Continue with exam_detail.html next... -->

<div class="container mt-5">

  <div class="container">
    <div id="question-nav">

      {% for num in q_nums %}
   {% with q_id=num|get_question_id:questions %}
    <div class="col p-0">
    <button
      class="btn btn-sm rounded-0 nav-btn
        {% if num == question_number %}
          btn-primary
        {% elif q_id|isin:request.session.answers %}
          btn-success
        {% else %}
          btn-outline-secondary
        {% endif %}"
      {% if num == question_number %}disabled{% endif %}
      title="Kanda hano kugirango ujye ku kibazo cya {{ num }}"
      data-question="{{ num }}"
      data-question-id="{{ q_id }}"
      >
      
      {% if num == question_number %}
        <strong>{{ num }}</strong>
      {% elif request.session.answers|get:q_id %}
        <strong>{{ num }}</strong>
      {% else %}
        {{ num }}
      {% endif %}
    </button>
  </div>
  {% endwith %}
    {% endfor %}

    </div>
  </div>
</div>
<div class="container mt-5 ">
  {# flash_message.html include removed to prevent duplication #}
  <!-- Exam Form -->
  <div class="question-container">
    <form method="POST" id="examForm" class="p-4 shadow-lg">
      {% csrf_token %}
      <input type="hidden" name="go_to" id="goToInput">
      <input type="hidden" name="question_id" value="{{ question.id }}">
      <div class="mb-5">
        <p class="fs-1 d-none d-md-block">{{ question_number }}. {{ question.question_text }}</p>
        <p class="fs-3 d-block d-md-none">{{ question_number }}. {{ question.question_text }}</p>
      </div>

      {% if question.question_sign %}
            <div class="mt-2 mb-4 text-center mx-auto" style="max-width: 80vw;">
              <img src="{{ question.question_sign.sign_image.url }}" alt="Amategeko y'umuhanda - Ibimenyetso by'umuhanda" class="img-thumbnail q-sign" >
            </div>
      {% endif %}

      <fieldset class="mt-5 mb-4 ">

        {% for choice in choices %}
        <div class="form-check mb-3 border p-2 rounded-3 border-secondary" title="Hitampo '{{ forloop.counter0|letter }}' nk'igisubizo cy'ukuri">
          <input class="form-check-input " type="radio" name="answer" id="choice-{{ choice.id }}" value="{{ choice.id }}"
                 {% if choice.id|stringformat:"s" == request.session.answers|get:question.id %}checked{% endif %}>
          <label class="form-check-label d-flex align-items-start" for="choice-{{ choice.id }}">
            <span class="fs-2 me-2">{{ forloop.counter0|letter }})</span>
            {% if choice.type == 'text' %}
            <span class="fs-3">{{ choice.content }}</span>
            {% elif choice.type == 'image' %}
            <img src="{{ choice.content }}" alt="Amategeko y'umuhanda - Ibyapa" class="img-thumbnail me-2" style="max-width: 30vw; height: auto;">
            
            {% endif %}
          </label>
        </div>
        {% endfor %}
      </fieldset>

      <div class="d-flex justify-content-between">
        <button type="button" id="prevBtn" class="btn btn-secondary " {% if question_number == 1 %}disabled{% endif %} title="Subira ku kibazo cya {{ question_number|add:-1 }}">Subira inyuma</button>


        {% if question_number < total_questions %}
        <button type="button" id="nextBtn" class="btn btn-primary" title="Komeza ku kibazo cya {{ question_number|add:1 }}">Next</button>
        {% else %}
        <button type="button" name="submit" class="btn btn-success" data-bs-toggle="modal" data-bs-target="#submitModal" id="submitExamBtn" title="Soza ikizamini urebe amanota">
          Soza ikizamini
        </button>
        {% endif %}
      </div>
    </form>
  </div>


</div>

<!-- Submission Confirmation Modal -->
<div class="modal fade" id="submitModal" tabindex="-1" aria-labelledby="submitModalLabel"     aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="submitModalLabel">Emeza ko wasoje ikizamini</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        Nibyo koko ikizamini wagisoje?
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Oya</button>
        <button type="submit" class="btn btn-success" id="confirmSubmit" name="submit" form="examForm">Reba amanota</button>
      </div>
    </div>
  </div>
</div>

<script>
  (function() {
    // Beforeunload Warning
    function beforeUnloadHandler(e) {
      const message = "Urashaka kuva ku rupapuro rwâ€™ikizamini? Ushobora gutakaza ibisubizo byawe.";
      e.preventDefault();
      e.returnValue = message;
      return message;
    }
    
    window.addEventListener('beforeunload', beforeUnloadHandler);

    // Remove warning when navigating within the exam or submitting the form
    function removeBeforeUnload() {
      window.removeEventListener('beforeunload', beforeUnloadHandler);
    }


    const confirmSubmitBtn = document.getElementById('confirmSubmit');
    const form = document.getElementById('examForm');

    // Remove beforeunload warning for form submission
    if (confirmSubmitBtn) confirmSubmitBtn.addEventListener('click', removeBeforeUnload);
    if (form) form.addEventListener('submit', removeBeforeUnload);

    const goToInput = document.getElementById('goToInput');


    // Initialize saved answers from session
    let savedAnswers = {};
    {% for key, value in request.session.answers.items %}
    savedAnswers['{{ key|escapejs }}'] = '{{ value|escapejs }}';
    {% endfor %}

    // Debounce flag for navigation
    let isNavigating = false;

    // AJAX navigation function
    function navigateToQuestion(questionNum) {
      if (isNavigating) return;
      isNavigating = true;
      // Save current answer before navigating
      const currentAnswer = document.querySelector('input[name="answer"]:checked');
      const answerValue = currentAnswer ? currentAnswer.value : '';
      // Get current question ID from the form
      const currentQuestionId = document.querySelector('input[name="question_id"]').value;
      fetch(`/exam/{{ exam.id }}/ajax/${questionNum}/`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/x-www-form-urlencoded',
          'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        },
        body: `answer=${answerValue}&question_id=${currentQuestionId}`
      })
      .then(response => response.json())
      .then(data => {
        if (data.html) {
          // Update the question content
          document.querySelector('.question-container').innerHTML = data.html;
          // Update saved answers locally
          if (answerValue) {
            savedAnswers[currentQuestionId] = answerValue;
          }
          // Scroll to top of page
          window.scrollTo(0, 0);
          // Update the question number display
          document.querySelector('.progress strong').textContent = `Ikibazo cya ${questionNum} muri {{ total_questions }}`;
          // Update URL without page reload
          history.pushState(null, '', `/exam/{{ exam.id }}/${questionNum}/`);
          // Update navigation button states
          updateNavigationButtons(questionNum);
          // Re-attach event listeners to new buttons
          attachQuestionEventListeners();
        }
        // Add redirect handling for non-subscribed users
        if (data.redirect) {
          // Clear the question content to prevent further interaction
          document.querySelector('.question-container').innerHTML = '';
          // Use both assign and replace for maximum compatibility
          window.location.assign(data.redirect);
          setTimeout(function() { window.location.replace(data.redirect); }, 100);
          return;
        }
      })
      .catch(error => console.error('Error:', error))
      .finally(() => { isNavigating = false; });
    }

    function updateNavigationButtons(currentQuestion) {
      // Update question nav buttons
      document.querySelectorAll('.nav-btn').forEach(btn => {
        const questionNum = parseInt(btn.getAttribute('data-question'));
        const questionId = btn.getAttribute('data-question-id');
        btn.classList.remove('btn-primary', 'btn-success', 'btn-outline-secondary');
        
        if (questionNum == currentQuestion) {
          btn.classList.add('btn-primary');
          btn.disabled = true;
        } else {
          // Check if this question has been answered
          if (savedAnswers[questionId]) {
            btn.classList.add('btn-success');
          } else {
            btn.classList.add('btn-outline-secondary');
          }
          btn.disabled = false;
        }
      });
    }

    function attachQuestionEventListeners() {
      // Use event delegation on the question container
      const questionContainer = document.querySelector('.question-container');
      if (questionContainer) {
        questionContainer.addEventListener('click', function(e) {
          const target = e.target;
          
          if (target.id === 'nextBtn') {
            e.preventDefault();
            e.stopPropagation();
            removeBeforeUnload();
            const currentQuestion = parseInt(window.location.pathname.split('/').filter(x => x).pop());
            navigateToQuestion(currentQuestion + 1);
          } else if (target.id === 'prevBtn') {
            e.preventDefault();
            e.stopPropagation();
            removeBeforeUnload();
            const currentQuestion = parseInt(window.location.pathname.split('/').filter(x => x).pop());
            navigateToQuestion(currentQuestion - 1);
          } else if (target.id === 'submitExamBtn') {
            
            
            // Save current answer before submitting
            const currentAnswer = document.querySelector('input[name="answer"]:checked');
            const answerValue = currentAnswer ? currentAnswer.value : '';
            
            // Submit the form normally
            const form = document.getElementById('examForm');
            const hiddenInput = document.createElement('input');
            hiddenInput.type = 'hidden';
            hiddenInput.name = 'answer';
            hiddenInput.value = answerValue;
            form.appendChild(hiddenInput);
            
            // Add submit flag
            const submitInput = document.createElement('input');
            submitInput.type = 'hidden';
            submitInput.name = 'submit';
            submitInput.value = 'true';
            form.appendChild(submitInput);
            
            form.submit();
          }
        });
      }
      
      // Attach listeners to top navigation buttons (these don't change)
      document.querySelectorAll('.nav-btn').forEach(btn => {
        btn.addEventListener('click', function(e) {
          e.preventDefault();
          e.stopPropagation();
          removeBeforeUnload();
          const questionNum = this.getAttribute('data-question');
          navigateToQuestion(questionNum);
        });
      });
    }

    // Attach initial event listeners using event delegation
    attachQuestionEventListeners();

    {% if  exam_end_time   %}
    
    // Countdown Timer
    const examEndTimeTimestamp = parseInt("{{ exam_end_time|default:0 }}", 10) * 1000;
    const countdownElement = document.getElementById("countdown");
    
    function updateCountdown() {
      const now = Date.now();
      const distance = examEndTimeTimestamp - now;
      
      if (distance <= 0) {
        clearInterval(timerInterval);
        countdownElement.innerText = "0:00";
        if (confirmSubmitBtn) {
          confirmSubmitBtn.click();
        }
        return;
      }
      
      const minutes = Math.floor(distance / (1000 * 60));
      const seconds = Math.floor((distance % (1000 * 60)) / 1000);
      countdownElement.innerText = `${minutes}:${seconds.toString().padStart(2, '0')}`;
      
      if (distance < 60000) {
        countdownElement.classList.replace('bg-success', 'bg-danger');
      }
    }
    const timerInterval = setInterval(updateCountdown, 1000);
    updateCountdown();
    
    {% endif %}

    // Custom Styling for Radio Button Selection
    const radioInputs = document.querySelectorAll('input[type="radio"][name="answer"]');
    radioInputs.forEach(radio => {
      radio.addEventListener('change', function() {
        document.querySelectorAll('.form-check-label').forEach(label => label.classList.remove('selected-choice'));
        const label = document.querySelector(`label[for="${this.id}"]`);
        if (label) label.classList.add('selected-choice');
      });
    });

    // Apply style to pre-selected radio buttons on page load
    radioInputs.forEach(radio => {
      if (radio.checked) {
        const label = document.querySelector(`label[for="${radio.id}"]`);
        if (label) label.classList.add('selected-choice');
      }
    });
  })();
</script>
{% endblock %}
